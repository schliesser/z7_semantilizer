import{Headline}from"@zeroseven/semantilizer/Headline.js";import{Module}from"@zeroseven/semantilizer/Module.js";import{Notification}from"@zeroseven/semantilizer/Notification.js";import{Cast}from"@zeroseven/semantilizer/Cast.js";import{Issue}from"@zeroseven/semantilizer/Issue.js";import AjaxDataHandler from"@typo3/backend/ajax-data-handler.js";import interact from"interactjs";class Semantilizer{constructor(e,t,...i){this.url=e,this.contentSelectors=Cast.array(i||"body"),this.module=new Module(document.getElementById(t),this),this.notification=new Notification(this),this.headlines=[],this.issues=[],this.validate=this.validate.bind(this),this.init()}collect(e){let i=new XMLHttpRequest;this.headlines.length=0,i.onreadystatechange=()=>{if(4===i.readyState){if(200===i.status){const t=(new DOMParser).parseFromString(i.responseText,"text/html");this.contentSelectors.map(e=>t.querySelector(e)).filter(e=>e).forEach(e=>{this.headlines.push(...Cast.array((e||t).querySelectorAll("h1, h2, h3, h4, h5, h6")).map(e=>new Headline(e,this)))})}"function"==typeof e&&e(i)}},i.open("GET",(this.url.indexOf("#")<0?this.url:this.url.substr(0,this.url.indexOf("#")))+"#"+Math.random().toString(36).slice(2),!0),i.setRequestHeader("X-Semantilizer","true"),i.send()}validateStructure(){this.issues.length=0;var e,t,i=()=>{this.headlines.forEach((e,t)=>{t&&e.type>this.headlines[t-1].type+1&&this.issues.push(Issue.headingStructure(e))})};this.headlines.length&&(e=this.headlines[0],0===(t=this.headlines.filter(e=>1===e.type)).length&&this.issues.push(Issue.mainHeadingRequired(e,1)),1<t.length&&this.headlines.forEach((e,t)=>{1===e.type&&this.issues.push(Issue.mainHeadingNumber(e,t?2:null))}),1===t.length&&1!==e.type&&(this.issues.push(Issue.mainHeadingPosition(e,1)),this.headlines.forEach((e,t)=>{t&&1===e.type&&this.issues.push(Issue.mainHeadingPosition(e,2))})),i())}validate(){this.validateStructure(),this.module.drawStructure(),this.notification.hideAll(),this.notification.autoload.enabled()&&this.notification.showIssues()}refresh(e){!0===e&&this.module.lockStructure(),this.collect(e=>{200===e.status?this.validate():(this.notification.hideAll(),this.module.drawError())})}revalidate(e){!0===e?(this.module.drawStructure(),this.notification.hideAll(),this.refresh(!0)):this.validate()}update(t){const i=this.headlines.filter(e=>e.isModified()&&e.isEditableType()),a={data:{}};let r=!1;i.forEach(e=>{var t=e.edit.table,i=e.edit.uid,s=e.edit.field;a.data[t]=a.data[t]||{},a.data[t][i]={},a.data[t][i][s]=e.type,e.hasRelations()&&(r=!0)}),Object.keys(a).length&&AjaxDataHandler.process(a).then(e=>{e.hasErrors||this.revalidate(r),i.forEach(e=>e.hasStored()),"function"==typeof t&&t(e)})}init(){this.refresh(),this.module.loader(),interact(".t3js-page-ce-sortable").draggable({onend:()=>this.refresh(!0)})}}export{Semantilizer};