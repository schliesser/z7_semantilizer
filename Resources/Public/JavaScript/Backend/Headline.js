"use strict";function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}define(["TYPO3/CMS/Backend/AjaxDataHandler","TYPO3/CMS/Z7Semantilizer/Backend/Converter"],function(n,t){var r=function(){function n(e){var t=this;_classCallCheck(this,n);var i={};if(e.dataset.semantilizer)try{i=JSON.parse(e.dataset.semantilizer)}catch(e){"function"==typeof console.log&&console.log(e,1640904719)}["table","uid","field","relationId","relatedTo"].forEach(function(e){return t["_"+e]=i[e]||null})}return _createClass(n,[{key:"table",get:function(){return this._table},set:function(e){this._table=(e||"").trim()}},{key:"uid",get:function(){return this._uid},set:function(e){this._uid=t.toInteger(e)}},{key:"field",get:function(){return this._field},set:function(e){this._field=(e||"").trim()}},{key:"relationId",get:function(){return this._relationId},set:function(e){this._relationId=(e||"").trim()}},{key:"relatedTo",get:function(){return this._relatedTo},set:function(e){this._relatedTo=(e||"").trim()}}]),n}(),i=_createClass(function e(t,i){_classCallCheck(this,e),this.key=t,this.fix=i}),s=function(){function t(e){_classCallCheck(this,t),this.list={},this.list[t.mainHeadingRequired]=null,this.list[t.mainHeadingNumber]=null,this.list[t.mainHeadingPosition]=null,this.list[t.headingStructure]=null,this.parent=e}return _createClass(t,[{key:"count",value:function(){var t=this,i=0;return Object.keys(this.list).forEach(function(e){return i+=t.list[e]?1:0}),i}},{key:"empty",value:function(){return 0===this.count()}},{key:"add",value:function(e,t){"undefined"!==this.list[e]?this.list[e]=new i(e,t):console.warn('Not allowed error key "'+e+'"',1641814278)}},{key:"each",value:function(t){var i=this;return Object.keys(this.list).filter(function(e){return i.list[e]}).forEach(function(e){return t(i.list[e],e)})}},{key:"get",value:function(e){return this.list[e]||null}},{key:"has",value:function(e){return null!==this.get(e)}},{key:"remove",value:function(e){this.list[e]=null}},{key:"clear",value:function(){var t=this;Object.keys(this.list).forEach(function(e){return t.list[e]=null})}},{key:"fix",value:function(e,t){var i=this.get(e);i&&i.fix&&this.parent.isEditableType()&&(this.parent.type=i.fix,this.remove(e),!0===t&&this.parent.store())}}]),t}();return _defineProperty(s,"mainHeadingRequired","mainHeadingRequired"),_defineProperty(s,"mainHeadingNumber","mainHeadingNumber"),_defineProperty(s,"mainHeadingPosition","mainHeadingPosition"),_defineProperty(s,"headingStructure","headingStructure"),function(){function i(e,t){_classCallCheck(this,i),this.type=e.nodeName,this.text=e.innerText,this.parent=t,this.edit=new r(e),this.issues=new s(this),this.showIssues=this.showIssues.bind(this)}return _createClass(i,[{key:"type",get:function(){return this._type},set:function(e){return this._type=Math.min(Math.max(t.toInteger(e),1),6),this}},{key:"text",get:function(){return this._text},set:function(e){return this._text=e.trim(),this}},{key:"store",value:function(e){this.isEditableType()&&i.storeHeadlines([this],e)}},{key:"getEditUrl",value:function(){if(this.isEditableRecord()){var e=encodeURIComponent(top.list_frame.document.location.pathname+top.list_frame.document.location.search);return top.TYPO3.settings.FormEngine.moduleUrl+"&edit["+this.edit.table+"]["+this.edit.uid+"]=edit&returnUrl="+e}return null}},{key:"hasRelations",value:function(){var t=this;return this.edit.relationId&&0<this.parent.headlines.filter(function(e){return e.edit.relatedTo===t.edit.relationId}).length}},{key:"relatedHeadline",value:function(){var t=this;if(this.edit.relatedTo){var e=this.parent.headlines.filter(function(e){return e.edit.relationId===t.edit.relatedTo});if(e.length)return e[e.length-1]}return null}},{key:"isRelated",value:function(){return null!==this.relatedHeadline()}},{key:"isEditableRecord",value:function(){return this.edit.table&&this.edit.uid}},{key:"isEditableType",value:function(){return this.isEditableRecord()&&this.edit.field&&!this.isRelated()}},{key:"showIssues",value:function(){var i=this;this.issues.count()&&this.issues.each(function(e,t){return i.parent.notifications.showIssue(t)})}}],[{key:"storeHeadlines",value:function(e,t){var r={data:{}},s=!1;e.forEach(function(e){var t,i,n;e.isEditableType()&&(t=e.edit.table,i=e.edit.uid,n=e.edit.field,r.data[t]=r.data[t]||{},r.data[t][i]={},r.data[t][i][n]=e.type),e.hasRelations()&&(s=!0)}),Object.keys(r).length&&n.process(r).done(function(e){return"function"==typeof t&&t(e,s)})}}]),i}()});